# SmartCompute Alerting Rules for Prometheus
groups:
  - name: smartcompute.service_health
    rules:
      # Service Down Alert
      - alert: ServiceDown
        expr: up == 0
        for: 30s
        labels:
          severity: critical
          service: "{{ $labels.job }}"
        annotations:
          summary: "SmartCompute service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} on {{ $labels.instance }} has been down for more than 30 seconds"

      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (
            rate(http_requests_total{status=~"5.."}[5m]) /
            rate(http_requests_total[5m]) * 100
          ) > 5
        for: 2m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "High error rate on {{ $labels.service }}"
          description: "Error rate is {{ $value }}% for {{ $labels.service }} on endpoint {{ $labels.endpoint }}"

      # Critical Error Rate
      - alert: CriticalErrorRate
        expr: |
          (
            rate(http_requests_total{status=~"5.."}[5m]) /
            rate(http_requests_total[5m]) * 100
          ) > 15
        for: 1m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "Critical error rate on {{ $labels.service }}"
          description: "Error rate is {{ $value }}% for {{ $labels.service }} - immediate attention required"

  - name: smartcompute.performance
    rules:
      # High Response Time
      - alert: HighResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(http_request_duration_seconds_bucket[5m])
          ) > 2.0
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "High response time on {{ $labels.service }}"
          description: "95th percentile response time is {{ $value }}s for {{ $labels.service }} {{ $labels.endpoint }}"

      # Very High Response Time
      - alert: VeryHighResponseTime
        expr: |
          histogram_quantile(0.95, 
            rate(http_request_duration_seconds_bucket[5m])
          ) > 10.0
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "Very high response time on {{ $labels.service }}"
          description: "95th percentile response time is {{ $value }}s for {{ $labels.service }} - performance severely degraded"

      # Analysis Queue Backup
      - alert: AnalysisQueueBackup
        expr: smartcompute_analysis_queue_size > 100
        for: 3m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "Analysis queue backup on {{ $labels.service }}"
          description: "Analysis queue size is {{ $value }} items - potential processing bottleneck"

      # Critical Queue Backup
      - alert: CriticalQueueBackup
        expr: smartcompute_analysis_queue_size > 500
        for: 1m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "Critical analysis queue backup on {{ $labels.service }}"
          description: "Analysis queue size is {{ $value }} items - system overloaded"

  - name: smartcompute.security
    rules:
      # High Threat Detection Rate
      - alert: HighThreatDetectionRate
        expr: |
          increase(smartcompute_threat_detections_total{severity=~"high|critical"}[5m]) > 10
        for: 1m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "High threat detection rate"
          description: "{{ $value }} high/critical threats detected in the last 5 minutes on {{ $labels.service }}"

      # Critical Threat Detected
      - alert: CriticalThreatDetected
        expr: |
          increase(smartcompute_threat_detections_total{severity="critical"}[1m]) > 0
        for: 0s
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "Critical threat detected"
          description: "Critical threat detected on {{ $labels.service }} - immediate security response required"

      # Authentication Failures
      - alert: HighAuthenticationFailures
        expr: |
          increase(http_requests_total{status="401"}[5m]) > 50
        for: 2m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "High authentication failure rate"
          description: "{{ $value }} authentication failures in 5 minutes on {{ $labels.service }} - possible brute force attack"

      # Multiple Security Violations
      - alert: SecurityViolationSpike
        expr: |
          increase(smartcompute_errors_total{error_type="security_violation"}[5m]) > 20
        for: 1m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "Security violation spike detected"
          description: "{{ $value }} security violations in 5 minutes - possible security breach"

  - name: smartcompute.database
    rules:
      # High Database Connection Usage
      - alert: HighDatabaseConnections
        expr: |
          database_connections_active / database_connections_max * 100 > 80
        for: 5m
        labels:
          severity: warning
          database: "{{ $labels.database }}"
        annotations:
          summary: "High database connection usage"
          description: "Database connection usage is {{ $value }}% for {{ $labels.database }}"

      # Database Query Timeout
      - alert: DatabaseQueryTimeout
        expr: |
          histogram_quantile(0.95, 
            rate(database_query_duration_seconds_bucket[5m])
          ) > 30
        for: 3m
        labels:
          severity: warning
          database: "{{ $labels.database }}"
        annotations:
          summary: "Database query timeout risk"
          description: "95th percentile query duration is {{ $value }}s for {{ $labels.database }}"

      # Database Down
      - alert: DatabaseDown
        expr: |
          postgres_up == 0
        for: 30s
        labels:
          severity: critical
          database: "postgresql"
        annotations:
          summary: "PostgreSQL database is down"
          description: "PostgreSQL database is unreachable - service will be severely impacted"

  - name: smartcompute.business
    rules:
      # Payment Failure Spike
      - alert: PaymentFailureSpike
        expr: |
          (
            rate(smartcompute_payments_total{status="failed"}[5m]) /
            rate(smartcompute_payments_total[5m]) * 100
          ) > 20
        for: 3m
        labels:
          severity: warning
          service: payment
        annotations:
          summary: "Payment failure rate spike"
          description: "Payment failure rate is {{ $value }}% - potential payment gateway issues"

      # No Analysis Requests
      - alert: NoAnalysisRequests
        expr: |
          increase(smartcompute_analysis_requests_total[15m]) == 0
        for: 10m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "No analysis requests received"
          description: "No analysis requests in the last 15 minutes on {{ $labels.service }} - potential client connectivity issues"

      # Revenue Drop
      - alert: RevenueDropAlert
        expr: |
          (
            increase(smartcompute_payment_amount_usd[1h]) /
            increase(smartcompute_payment_amount_usd[1h] offset 24h)
          ) < 0.5
        for: 30m
        labels:
          severity: warning
          service: payment
        annotations:
          summary: "Revenue drop detected"
          description: "Revenue is 50% lower than same time yesterday - investigate payment flow"

  - name: smartcompute.infrastructure
    rules:
      # High CPU Usage
      - alert: HighCPUUsage
        expr: smartcompute_cpu_usage_percent > 80
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "High CPU usage on {{ $labels.service }}"
          description: "CPU usage is {{ $value }}% on {{ $labels.service }}"

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: |
          smartcompute_memory_usage_bytes / 1024 / 1024 / 1024 > 1.5
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "High memory usage on {{ $labels.service }}"
          description: "Memory usage is {{ $value }}GB on {{ $labels.service }}"

      # Redis Down
      - alert: RedisDown
        expr: redis_up == 0
        for: 30s
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis is down"
          description: "Redis cache is unreachable - performance will be severely impacted"

      # Vault Sealed
      - alert: VaultSealed
        expr: vault_core_sealed == 1
        for: 30s
        labels:
          severity: critical
          service: vault
        annotations:
          summary: "HashiCorp Vault is sealed"
          description: "Vault is sealed - services will not be able to access secrets"