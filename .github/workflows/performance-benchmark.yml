name: "Performance Benchmark"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  performance-benchmark:
    name: Run Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[free]"
        pip install pytest pytest-asyncio httpx

    - name: System information
      run: |
        echo "System Information:"
        echo "==================="
        echo "OS: $(lsb_release -d | cut -f2)"
        echo "CPU: $(lscpu | grep 'Model name' | cut -d: -f2 | xargs)"
        echo "CPU Cores: $(nproc)"
        echo "Memory: $(free -h | grep Mem | awk '{print $2}')"
        echo "Python: $(python --version)"

    - name: Run test suite with timing
      run: |
        pytest tests/ -v --durations=10

    - name: Run API latency benchmark
      run: |
        python -c "
        import time, statistics, json
        from smartcompute.core import SmartComputeProcessMonitor, OSILayerAnalyzer, NetworkHostScanner
        import_time = 0
        scanner = NetworkHostScanner()
        times = []
        for _ in range(10):
            start = time.perf_counter()
            scanner.detect_local_subnets()
            times.append((time.perf_counter() - start) * 1000)
        subnet_mean = statistics.mean(times)
        subnet_p95 = sorted(times)[int(len(times) * 0.95)]
        print('Performance Benchmark Results')
        print('=' * 40)
        print(f'Subnet detection:     {subnet_mean:.2f}ms (mean), {subnet_p95:.2f}ms (p95)')
        assert subnet_mean < 100, f'Subnet detection too slow: {subnet_mean:.0f}ms'
        print()
        print('All quality gates passed')
        "
