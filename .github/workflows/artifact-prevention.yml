name: "Artifact Prevention & Deep Scanning"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  prevent-artifacts:
    name: Prevent Artifact Reintroduction
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install scanning tools
      run: |
        pip install --upgrade pip
        pip install bandit safety

    # Check for forbidden file patterns
    - name: Scan for forbidden artifacts
      run: |
        echo "Scanning for forbidden artifacts..."

        FORBIDDEN_PATTERNS=(
          "*.db"
          "*.sqlite*"
          "*history.json"
          "smart_history.json"
          "test_history.json"
          "smartcompute_history.json"
          "venv/"
          "smartcompute_env/"
          "temp_env/"
          "*.log"
          "logs/"
          "app_logs/"
          "monitoring_logs/"
          "__pycache__/"
          "*.pyc"
          "build/"
          "dist/"
          "*.egg-info/"
          "node_modules/"
          "*.jar"
          "*.war"
          "*.run"
          "*.exe"
          "*.dmg"
          "*.deb"
          "*.rpm"
          "*.msi"
          "*.zip"
          "*.tar.gz"
          "*.7z"
          "*.rar"
        )

        VIOLATIONS_FOUND=0
        for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
          if find . -path "./.git" -prune -o -name "$pattern" -type f -print | head -1 | grep -q .; then
            echo "FORBIDDEN ARTIFACT FOUND: $pattern"
            find . -path "./.git" -prune -o -name "$pattern" -type f -print
            VIOLATIONS_FOUND=1
          fi
        done

        if [ $VIOLATIONS_FOUND -eq 1 ]; then
          echo "CI FAILED: Forbidden artifacts detected!"
          exit 1
        fi

        echo "No forbidden artifacts found"

    # Scan for large files
    - name: Scan for large files
      run: |
        echo "Scanning for large files (>1MB)..."

        LARGE_FILES=$(find . -path "./.git" -prune -o -type f -size +1M -print)

        if [ -n "$LARGE_FILES" ]; then
          echo "Large files detected (>1MB):"
          echo "$LARGE_FILES" | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "  - $file ($size)"
          done

          VERY_LARGE_FILES=$(find . -path "./.git" -prune -o -type f -size +10M -print)
          if [ -n "$VERY_LARGE_FILES" ]; then
            echo "Files larger than 10MB are not allowed:"
            echo "$VERY_LARGE_FILES"
            exit 1
          fi

          echo "Warning: Large files detected but under 10MB limit"
        else
          echo "No large files found"
        fi

    # Scan for sensitive data patterns
    - name: Scan for sensitive data
      run: |
        echo "Scanning for sensitive data patterns..."

        python3 -c "
        import re, os, sys

        patterns = [
            r'password\s*=\s*[\"'\''][^\"'\'']+[\"'\'']',
            r'AKIA[0-9A-Z]{16}',
            r'sk-[a-zA-Z0-9]{48}',
            r'ghp_[a-zA-Z0-9]{36}',
            r'-----BEGIN [A-Z]+ PRIVATE KEY-----',
        ]

        violations = []
        for root, dirs, files in os.walk('.'):
            if '.git' in root:
                continue
            for f in files:
                if f.endswith(('.env', '.pem', '.key')):
                    filepath = os.path.join(root, f)
                    try:
                        with open(filepath, 'r', encoding='utf-8', errors='ignore') as fh:
                            content = fh.read()
                            for p in patterns:
                                if re.search(p, content, re.IGNORECASE):
                                    violations.append(filepath)
                                    break
                    except Exception:
                        continue

        if violations:
            print('Potential sensitive files found:')
            for v in violations:
                print(f'  - {v}')
            sys.exit(1)
        else:
            print('No sensitive data patterns found')
        "

    # Scan git history for secrets
    - name: Scan git history with gitleaks
      run: |
        echo "Scanning git history for secrets..."

        if command -v gitleaks &> /dev/null; then
          gitleaks detect --verbose --exit-code 0
        else
          echo "gitleaks not installed, skipping history scan"
        fi

        echo "Git history scan completed"

    # Repository health check
    - name: Repository health check
      run: |
        echo "Repository Health Check"
        echo "=========================="

        REPO_SIZE=$(du -sh .git | cut -f1)
        echo "Repository size: $REPO_SIZE"

        COMMIT_COUNT=$(git rev-list --all --count)
        echo "Total commits: $COMMIT_COUNT"

        echo "Current branch: $(git branch --show-current)"

        echo ""
        echo "Recent commits:"
        git log --oneline -5

        echo ""
        echo "File count by extension:"
        find . -name ".git" -prune -o -type f -print |
        sed 's/.*\.//' | sort | uniq -c | sort -nr | head -10

        echo "Repository health check completed"

    # Generate scan report
    - name: Generate scan report
      if: always()
      run: |
        cat > scan_report.md << 'REPORT'
        # Artifact Prevention Scan Report
        REPORT
        echo "- **Date**: $(date -u)" >> scan_report.md
        echo "- **Commit**: ${{ github.sha }}" >> scan_report.md
        echo "- **Branch**: ${{ github.ref_name }}" >> scan_report.md
        cat scan_report.md

    - name: Upload scan report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: artifact-prevention-report
        path: scan_report.md
